<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Masonry Grid</title>
    <!-- Masonry.js -->
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <!-- imagesLoaded - ensures layout after images load -->
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <!-- Flickr's justified-layout algorithm - load as module and expose globally -->
    <script type="module">
        import justifiedLayout from 'https://cdn.jsdelivr.net/npm/justified-layout@4.1.0/+esm';
        window.justifiedLayout = justifiedLayout;
        window.dispatchEvent(new Event('justifiedLayoutReady'));
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            background: #4a9eff;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .btn:hover {
            background: #3a8eef;
        }

        .btn.active {
            background: #2a7edf;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .vibe-grid {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Grid sizer for responsive column width */
        .grid-sizer,
        .vibe-item {
            width: calc(25% - 12px);
        }

        .vibe-item {
            margin-bottom: 15px;
            overflow: hidden;
            transition: none !important;
        }

        .vibe-item img {
            width: 100%;
            display: block;
        }

        /* Disable all Masonry transitions */
        .vibe-grid .vibe-item {
            transition: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #888;
            width: 100%;
        }

        /* Responsive columns */
        @media (max-width: 1200px) {
            .grid-sizer,
            .vibe-item {
                width: calc(33.333% - 10px);
            }
        }

        @media (max-width: 768px) {
            .grid-sizer,
            .vibe-item {
                width: calc(50% - 8px);
            }
        }

        @media (max-width: 480px) {
            .grid-sizer,
            .vibe-item {
                width: 100%;
            }
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #888;
            font-size: 14px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            color: #888;
            font-size: 14px;
        }

        .divider {
            width: 1px;
            height: 30px;
            background: #444;
            margin: 0 10px;
        }

        /* Insta Grid Layout - CSS only */
        #instaGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .insta-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            align-items: start;
        }

        .insta-item {
            background: #222;
            display: flex;
            flex-direction: column;
            aspect-ratio: 1 / 1;
        }

        .insta-item .image-wrapper {
            position: relative;
            width: 100%;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .insta-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .insta-item .caption {
            flex-shrink: 0;
        }

        /* Responsive insta grid */
        @media (max-width: 1200px) {
            .insta-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .insta-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .insta-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Big Layout - single column, full width */
        #bigGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .big-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .big-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Fit Layout - single column, max viewport height */
        #fitGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .fit-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--fit-gap, 15px);
        }

        .fit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fit-item img {
            max-width: 100%;
            max-height: var(--fit-img-height, calc(100vh - 60px));
            object-fit: contain;
        }

        /* Arc Grid Layout - uses justified-layout algorithm */
        #arcGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
            position: relative;
        }

        .arc-item {
            position: absolute;
            left: 0;
            top: 0;
            will-change: transform;
            overflow: hidden;
        }

        .arc-item .image-wrapper {
            width: 100%;
            overflow: hidden;
        }

        .arc-item img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        /* Caption styles - below image for most layouts */
        .caption {
            padding: 8px 12px;
            background: #222;
            color: #fff;
            font-size: 14px;
            line-height: 1.3;
            text-align: center;
        }

        /* Vibe items */
        .vibe-item {
            background: #222;
            overflow: hidden;
        }

        .vibe-item img {
            display: block;
        }

        /* Big/Fit items */
        .big-item,
        .fit-item {
            background: #222;
        }

        /* Hidden container for measuring caption heights */
        .caption-measurer {
            position: absolute;
            visibility: hidden;
            pointer-events: none;
            /* Match caption styling exactly */
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Gallery Layout Playground</h1>
    </div>

    <div class="controls">
        <div class="control-group">
            <span class="control-label">Images:</span>
            <button class="btn active" id="btnSamples" onclick="switchToSet('samples')">Samples (40)</button>
            <button class="btn" id="btnPics" onclick="switchToSet('pics')">Photos (68)</button>
        </div>
        <div class="divider"></div>
        <div class="control-group">
            <span class="control-label">Layout:</span>
            <button class="btn active" id="btnArc" onclick="switchLayout('arc')">Arc</button>
            <button class="btn" id="btnVibe" onclick="switchLayout('vibe')">Vibe</button>
            <button class="btn" id="btnInsta" onclick="switchLayout('insta')">Insta</button>
            <button class="btn" id="btnFit" onclick="switchLayout('fit')">Fit</button>
            <button class="btn" id="btnBig" onclick="switchLayout('big')">Big</button>
        </div>
    </div>

    <div class="stats" id="stats">40 samples</div>

    <div class="vibe-grid" id="vibeGrid">
        <div class="grid-sizer"></div>
    </div>

    <div id="instaGrid">
        <div class="insta-grid"></div>
    </div>

    <div id="arcGrid"></div>

    <div id="bigGrid">
        <div class="big-grid"></div>
    </div>

    <div id="fitGrid">
        <div class="fit-grid"></div>
    </div>

    <script>
        // Static image list from pics/ folder - NYE 2025 party photos
        const picsImages = [
            'pics/Img00001.jpg', 'pics/Img00002.jpg', 'pics/Img00003.jpg', 
            { src: 'pics/Img00004.jpg', caption: "Gleb!!!!"},
            'pics/Img00005.jpg', 'pics/Img00006.jpg', 'pics/Img00007.jpg', 'pics/Img00008.jpg',
            'pics/Img00009.jpg', { src: 'pics/Img00010.jpg', caption: 'Victor believes the glitter cannons were a terrible idea' },
            'pics/Img00011.jpg', 'pics/Img00012.jpg',
            'pics/Img00013.jpg', 'pics/Img00014.jpg', 'pics/Img00015.jpg', 'pics/Img00016.jpg',
            'pics/Img00017.jpg', 'pics/Img00018.jpg', 'pics/Img00019.jpg',
            { src: 'pics/Img00020.jpg', caption: 'Everyone chatting away gleefully' },
            'pics/Img00021.jpg', 'pics/Img00022.jpg', 'pics/Img00023.jpg', 'pics/Img00024.jpg',
            'pics/Img00025.jpg', 'pics/Img00026.jpg', 'pics/Img00027.jpg', 'pics/Img00028.jpg',
            'pics/Img00029.jpg', { src: 'pics/Img00030.jpg', caption: 'A rare photo of the photographer!' },
            'pics/Img00031.jpg', 'pics/Img00032.jpg',
            'pics/Img00033.jpg', 'pics/Img00034.jpg', 'pics/Img00035.jpg', 'pics/Img00036.jpg',
            'pics/Img00037.jpg', 'pics/Img00038.jpg', 'pics/Img00039.jpg',
            { src: 'pics/Img00040.jpg', caption: '2025 resolution: remember where I left my shoes' },
            'pics/Img00041.jpg', 'pics/Img00042.jpg', 'pics/Img00043.jpg', 'pics/Img00044.jpg',
            'pics/Img00045.jpg', 'pics/Img00046.jpg', 'pics/Img00047.jpg', 'pics/Img00048.jpg',
            'pics/Img00049.jpg', { src: 'pics/Img00050.jpg', caption: 'Caviar is really the only way I can celebrate new years.' },
            'pics/Img00051.jpg', 'pics/Img00052.jpg',
            'pics/Img00053.jpg', 'pics/Img00054.jpg', 'pics/Img00055.jpg', 'pics/Img00056.jpg',
            'pics/Img00057.jpg', 'pics/Img00058.jpg', 'pics/Img00059.jpg',
            { src: 'pics/Img00060.jpg', caption: 'Girls and Martinis' },
            'pics/Img00061.jpg', 'pics/Img00062.jpg', 'pics/Img00063.jpg', 'pics/Img00064.jpg',
            'pics/Img00065.jpg', 'pics/Img00066.jpg', 'pics/Img00067.jpg', 'pics/Img00068.jpg'
        ];

        // Sample images from samples/ folder - some with captions
        const samplesImages = [
            { src: 'samples/0001.jpg', caption: 'Morning light through the window' },
            'samples/0002.jpg',
            { src: 'samples/0003.jpg', caption: 'A quiet moment' },
            'samples/0004.jpg',
            'samples/0005.jpg',
            { src: 'samples/0006.jpg', caption: 'Reflections on water' },
            'samples/0007.jpg',
            'samples/0008.jpg',
            { src: 'samples/0009.jpg', caption: 'The old oak tree' },
            'samples/0010.jpg',
            'samples/0011.jpg',
            'samples/0012.jpg',
            { src: 'samples/0013.jpg', caption: 'Summer afternoon' },
            'samples/0014.jpg',
            'samples/0015.jpg',
            { src: 'samples/0016.jpg', caption: 'City lights at dusk' },
            'samples/0017.jpg',
            'samples/0018.jpg',
            'samples/0019.jpg',
            { src: 'samples/0020.jpg', caption: 'Patterns in nature' },
            'samples/0021.jpg',
            'samples/0022.jpg',
            'samples/0023.jpg',
            'samples/0024.jpg',
            { src: 'samples/0025.jpg', caption: 'First snow of winter' },
            'samples/0026.jpg',
            'samples/0027.jpg',
            'samples/0028.jpg',
            'samples/0029.jpg',
            { src: 'samples/0030.jpg', caption: 'Golden hour' },
            'samples/0031.jpg',
            'samples/0032.jpg',
            'samples/0033.jpg',
            'samples/0034.jpg',
            'samples/0035.jpg',
            { src: 'samples/0036.jpg', caption: 'Storm clouds gathering' },
            'samples/0037.jpg',
            'samples/0038.jpg',
            'samples/0039.jpg',
            { src: 'samples/0040.jpg', caption: 'End of the journey' }
        ];
        
        let currentSet = 'samples';
        let currentLayout = 'arc';
        let currentImages = [...samplesImages];
        let msnry = null;
        
        // Cache for Arc Grid - stores loaded image data to avoid reloading on resize
        let arcGridCache = { images: null, loadedImages: null, elements: null, captionHeights: null };

        // Minimum width for caption measurement (conservative estimate for narrow portrait images)
        const CAPTION_MIN_WIDTH = 180;
        // Buffer added to measured caption height for safety
        const CAPTION_HEIGHT_BUFFER = 4;

        // Measure caption heights at a minimum width constraint
        function measureCaptionHeights(loadedImages, minWidth = CAPTION_MIN_WIDTH) {
            // Create or reuse measuring element
            let measurer = document.getElementById('captionMeasurer');
            if (!measurer) {
                measurer = document.createElement('div');
                measurer.id = 'captionMeasurer';
                measurer.className = 'caption-measurer';
                document.body.appendChild(measurer);
            }
            
            // Set width constraint
            measurer.style.width = minWidth + 'px';
            
            // Measure each caption
            const heights = loadedImages.map(img => {
                if (!img.caption) return 0;
                measurer.textContent = img.caption;
                return measurer.offsetHeight + CAPTION_HEIGHT_BUFFER;
            });
            
            // Clear measurer
            measurer.textContent = '';
            
            return heights;
        }

        // ============================================================
        // Layout Registry - centralized layout configuration
        // ============================================================
        const layouts = {
            vibe: {
                gridId: 'vibeGrid',
                buttonId: 'btnVibe',
                render: renderVibeContent
            },
            insta: {
                gridId: 'instaGrid',
                buttonId: 'btnInsta',
                render: renderInstaContent
            },
            arc: {
                gridId: 'arcGrid',
                buttonId: 'btnArc',
                render: renderArcContent
            },
            big: {
                gridId: 'bigGrid',
                buttonId: 'btnBig',
                render: renderBigContent
            },
            fit: {
                gridId: 'fitGrid',
                buttonId: 'btnFit',
                render: renderFitContent
            }
        };

        // ============================================================
        // Helper Functions
        // ============================================================
        
        // Helper: normalize item to { src, caption } format
        function normalizeItem(item) {
            if (typeof item === 'string') {
                return { src: item, caption: null };
            }
            return { src: item.src, caption: item.caption || null };
        }

        // Helper: create caption element if caption exists
        function createCaptionElement(caption) {
            if (!caption) return null;
            const captionEl = document.createElement('div');
            captionEl.className = 'caption';
            captionEl.textContent = caption;
            return captionEl;
        }

        // Helper: destroy masonry instance if it exists
        function teardownMasonry() {
            if (msnry) {
                msnry.destroy();
                msnry = null;
            }
        }

        // Helper: show only the specified grid, hide all others
        function showOnly(gridId) {
            Object.values(layouts).forEach(layout => {
                document.getElementById(layout.gridId).style.display = (layout.gridId === gridId) ? 'block' : 'none';
            });
        }

        // Helper: update button active states
        function updateButtonStates(activeLayout) {
            Object.entries(layouts).forEach(([name, config]) => {
                document.getElementById(config.buttonId).classList.toggle('active', name === activeLayout);
            });
        }

        // ============================================================
        // Layout Switching
        // ============================================================

        function switchToSet(setName) {
            if (setName === currentSet) return;
            
            currentSet = setName;
            
            // Update button states
            document.getElementById('btnPics').classList.toggle('active', setName === 'pics');
            document.getElementById('btnSamples').classList.toggle('active', setName === 'samples');
            
            // Switch image arrays
            if (setName === 'pics') {
                currentImages = [...picsImages];
                document.getElementById('stats').textContent = `${picsImages.length} photos`;
            } else {
                currentImages = [...samplesImages];
                document.getElementById('stats').textContent = `${samplesImages.length} samples`;
            }
            
            // Clear arc cache when changing image set
            arcGridCache = { images: null, loadedImages: null, elements: null };
            
            // Re-render with current layout
            renderCurrentLayout();
        }

        function switchLayout(layoutName) {
            if (layoutName === currentLayout) return;
            
            currentLayout = layoutName;
            updateButtonStates(layoutName);
            renderCurrentLayout();
        }

        function renderCurrentLayout() {
            const layout = layouts[currentLayout];
            if (layout) {
                // Teardown masonry before switching (unless we're switching TO vibe)
                if (currentLayout !== 'vibe') {
                    teardownMasonry();
                }
                showOnly(layout.gridId);
                layout.render(currentImages);
            }
        }

        // ============================================================
        // Vibe Layout (Masonry.js)
        // ============================================================

        function initMasonry() {
            const grid = document.getElementById('vibeGrid');
            
            // Destroy existing instance if it exists
            if (msnry) {
                msnry.destroy();
            }
            
            // Initialize Masonry
            msnry = new Masonry(grid, {
                itemSelector: '.vibe-item',
                columnWidth: '.grid-sizer',
                percentPosition: true,
                gutter: 15,
                originLeft: true,
                originTop: true,
                horizontalOrder: false
            });
            
            // Re-layout after all images load
            imagesLoaded(grid, function() {
                msnry.layout();
            });
        }

        function renderVibeContent(images) {
            const grid = document.getElementById('vibeGrid');
            grid.innerHTML = '<div class="grid-sizer"></div>';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'vibe-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                itemEl.appendChild(img);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
            
            initMasonry();
        }

        // ============================================================
        // Insta Layout
        // ============================================================
        
        function renderInstaContent(images) {
            const grid = document.querySelector('#instaGrid .insta-grid');
            grid.innerHTML = '';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'insta-item';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                wrapper.appendChild(img);
                itemEl.appendChild(wrapper);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Big Layout
        // ============================================================
        
        function renderBigContent(images) {
            const grid = document.querySelector('#bigGrid .big-grid');
            grid.innerHTML = '';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'big-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                itemEl.appendChild(img);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Fit Layout
        // ============================================================

        function renderFitContent(images) {
            const grid = document.querySelector('#fitGrid .fit-grid');
            grid.innerHTML = '';
            
            // Calculate available height for image
            // Viewport height - gap (between items) - caption height (padding + text)
            const gap = 15;
            const captionHeight = 36; // 8px padding top + 8px padding bottom + ~18px text (14px * 1.3)
            const viewportHeight = window.innerHeight;
            const imageMaxHeight = viewportHeight - gap - captionHeight;
            
            // Set CSS custom properties
            grid.style.setProperty('--fit-gap', gap + 'px');
            grid.style.setProperty('--fit-img-height', imageMaxHeight + 'px');
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'fit-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                itemEl.appendChild(img);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Arc Layout (justified-layout algorithm)
        // ============================================================

        function renderArcContent(images) {
            const container = document.getElementById('arcGrid');
            
            // Wait for justified-layout module to load if not ready
            const doLayout = () => {
                // Check if we can use cached data
                const isSameImages = arcGridCache.images === images && arcGridCache.loadedImages;
                
                if (isSameImages) {
                    // Use cached data - just relayout
                    relayoutArcGrid();
                    return;
                }
                
                // Clear container for fresh render
                container.innerHTML = '';
                
                // Load all images to get their dimensions
                const imagePromises = images.map(item => {
                    const { src, caption } = normalizeItem(item);
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve({ src, caption, width: img.naturalWidth, height: img.naturalHeight });
                        img.onerror = () => resolve({ src, caption, width: 1, height: 1 }); // fallback
                        img.src = src;
                    });
                });
                
                Promise.all(imagePromises).then(loadedImages => {
                    // Measure caption heights before layout
                    const captionHeights = measureCaptionHeights(loadedImages);
                    
                    // Cache the loaded image data and measured heights
                    arcGridCache.images = images;
                    arcGridCache.loadedImages = loadedImages;
                    arcGridCache.captionHeights = captionHeights;
                    arcGridCache.elements = [];
                    
                    // Get container width
                    const containerWidth = container.parentElement.clientWidth > 1400 ? 1400 : container.parentElement.clientWidth - 40;
                    
                    const TARGET_ROW_HEIGHT = 350;
                    
                    // Calculate aspect ratios for justified-layout
                    // For captioned images, use modified aspect ratio that accounts for measured caption height
                    const imageAspectRatios = loadedImages.map(img => img.width / img.height);
                    const layoutAspectRatios = loadedImages.map((img, i) => {
                        const ar = imageAspectRatios[i];
                        const captionH = captionHeights[i];
                        if (captionH > 0) {
                            // Card aspect ratio: narrower to fit image + caption in same row height
                            // card_width / card_height = (img_ar * (h - caption)) / h
                            return ar * (TARGET_ROW_HEIGHT - captionH) / TARGET_ROW_HEIGHT;
                        }
                        return ar;
                    });
                    
                    // Run justified-layout algorithm with modified aspect ratios
                    const geometry = window.justifiedLayout(layoutAspectRatios, {
                        containerWidth: containerWidth,
                        targetRowHeight: TARGET_ROW_HEIGHT,
                        targetRowHeightTolerance: 0.20,
                        boxSpacing: 15
                    });
                    
                    // Set container height
                    container.style.height = geometry.containerHeight + 'px';
                    
                    // Create positioned elements
                    geometry.boxes.forEach((box, index) => {
                        const item = document.createElement('div');
                        item.className = 'arc-item';
                        item.style.transform = `translate(${box.left}px, ${box.top}px)`;
                        item.style.width = box.width + 'px';
                        item.style.height = box.height + 'px';
                        
                        const wrapper = document.createElement('div');
                        wrapper.className = 'image-wrapper';
                        // Height will be set after caption is measured at actual width
                        
                        const img = document.createElement('img');
                        img.src = loadedImages[index].src;
                        img.alt = loadedImages[index].src.split('/').pop();
                        
                        wrapper.appendChild(img);
                        item.appendChild(wrapper);
                        
                        // Add caption if present
                        const captionEl = createCaptionElement(loadedImages[index].caption);
                        if (captionEl) item.appendChild(captionEl);
                        
                        container.appendChild(item);
                        
                        // Cache element reference
                        arcGridCache.elements.push({ el: item, box });
                    });
                    
                    // After DOM is built, measure actual caption heights and set image wrapper heights
                    requestAnimationFrame(() => {
                        arcGridCache.elements.forEach(({ el, box }) => {
                            const caption = el.querySelector('.caption');
                            const wrapper = el.querySelector('.image-wrapper');
                            const actualCaptionHeight = caption ? caption.offsetHeight : 0;
                            wrapper.style.height = (box.height - actualCaptionHeight) + 'px';
                        });
                    });
                });
            };
            
            if (window.justifiedLayout) {
                doLayout();
            } else {
                window.addEventListener('justifiedLayoutReady', doLayout, { once: true });
            }
        }
        
        // Fast relayout for Arc Grid - reuses cached data and DOM elements
        function relayoutArcGrid() {
            if (!arcGridCache.loadedImages || !arcGridCache.elements || !arcGridCache.captionHeights) return;
            
            const container = document.getElementById('arcGrid');
            const loadedImages = arcGridCache.loadedImages;
            const captionHeights = arcGridCache.captionHeights;
            const elements = arcGridCache.elements;
            
            // Get current container width
            const containerWidth = container.parentElement.clientWidth > 1400 ? 1400 : container.parentElement.clientWidth - 40;
            
            const TARGET_ROW_HEIGHT = 350;
            
            // Calculate layout aspect ratios using cached caption heights
            const imageAspectRatios = loadedImages.map(img => img.width / img.height);
            const layoutAspectRatios = loadedImages.map((img, i) => {
                const ar = imageAspectRatios[i];
                const captionH = captionHeights[i];
                if (captionH > 0) {
                    return ar * (TARGET_ROW_HEIGHT - captionH) / TARGET_ROW_HEIGHT;
                }
                return ar;
            });
            
            // Recalculate layout
            const geometry = window.justifiedLayout(layoutAspectRatios, {
                containerWidth: containerWidth,
                targetRowHeight: TARGET_ROW_HEIGHT,
                targetRowHeightTolerance: 0.20,
                boxSpacing: 15
            });
            
            // Update container height
            container.style.height = geometry.containerHeight + 'px';
            
            // Update element positions and sizes
            geometry.boxes.forEach((box, index) => {
                const cached = elements[index];
                if (cached && cached.el) {
                    const item = cached.el;
                    // Update cached box for future reference
                    cached.box = box;
                    
                    item.style.transform = `translate(${box.left}px, ${box.top}px)`;
                    item.style.width = box.width + 'px';
                    item.style.height = box.height + 'px';
                }
            });
            
            // After positions update, measure actual caption heights and set image wrapper heights
            requestAnimationFrame(() => {
                elements.forEach(({ el, box }) => {
                    const caption = el.querySelector('.caption');
                    const wrapper = el.querySelector('.image-wrapper');
                    const actualCaptionHeight = caption ? caption.offsetHeight : 0;
                    if (wrapper) {
                        wrapper.style.height = (box.height - actualCaptionHeight) + 'px';
                    }
                });
            });
        }

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            if (currentLayout === 'vibe' && msnry) {
                msnry.layout();
            } else if (currentLayout === 'arc') {
                // Debounce resize for arc grid - use fast relayout
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => relayoutArcGrid(), 16); // ~60fps
            } else if (currentLayout === 'fit') {
                // Recalculate fit image height on resize
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const grid = document.querySelector('#fitGrid .fit-grid');
                    if (grid) {
                        const gap = 15;
                        const captionHeight = 36;
                        const imageMaxHeight = window.innerHeight - gap - captionHeight;
                        grid.style.setProperty('--fit-img-height', imageMaxHeight + 'px');
                    }
                }, 16);
            }
        });

        // Load images on page load
        document.addEventListener('DOMContentLoaded', function() {
            renderCurrentLayout();
        });
    </script>
</body>
</html>
