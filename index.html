<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Masonry Grid</title>
    <!-- Masonry.js -->
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <!-- imagesLoaded - ensures layout after images load -->
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <!-- Flickr's justified-layout algorithm - load as module and expose globally -->
    <script type="module">
        import justifiedLayout from 'https://cdn.jsdelivr.net/npm/justified-layout@4.1.0/+esm';
        window.justifiedLayout = justifiedLayout;
        window.dispatchEvent(new Event('justifiedLayoutReady'));
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            background: #4a9eff;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .btn:hover {
            background: #3a8eef;
        }

        .btn.active {
            background: #2a7edf;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .masonry-grid {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Grid sizer for responsive column width */
        .grid-sizer,
        .masonry-item {
            width: calc(25% - 12px);
        }

        .masonry-item {
            margin-bottom: 15px;
            overflow: hidden;
            transition: none !important;
        }

        .masonry-item img {
            width: 100%;
            display: block;
        }

        /* Disable all Masonry transitions */
        .masonry-grid .masonry-item {
            transition: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #888;
            width: 100%;
        }

        /* Responsive columns */
        @media (max-width: 1200px) {
            .grid-sizer,
            .masonry-item {
                width: calc(33.333% - 10px);
            }
        }

        @media (max-width: 768px) {
            .grid-sizer,
            .masonry-item {
                width: calc(50% - 8px);
            }
        }

        @media (max-width: 480px) {
            .grid-sizer,
            .masonry-item {
                width: 100%;
            }
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #888;
            font-size: 14px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            color: #888;
            font-size: 14px;
        }

        .divider {
            width: 1px;
            height: 30px;
            background: #444;
            margin: 0 10px;
        }

        /* Square Grid Layout - CSS only */
        #squareGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .square-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            align-items: start;
        }

        .square-item {
            background: #222;
        }

        .square-item .image-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
        }

        .square-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Responsive square grid */
        @media (max-width: 1200px) {
            .square-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .square-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .square-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Fixed Grid Layout - square cells with contained images */
        #fixedGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .fixed-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            align-items: start;
        }

        .fixed-item {
            background: #000;
        }

        .fixed-item .image-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fixed-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Responsive fixed grid */
        @media (max-width: 1200px) {
            .fixed-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .fixed-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .fixed-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Overflow-height Layout - single column, full width */
        #overflowheightGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .overflowheight-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .overflowheight-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Fit-screen Layout - single column, max viewport height */
        #fitscreenGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .fitscreen-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--fitscreen-gap, 15px);
        }

        .fitscreen-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fitscreen-item img {
            max-width: 100%;
            max-height: var(--fitscreen-img-height, calc(100vh - 60px));
            object-fit: contain;
        }

        /* Flickr Grid Layout - uses justified-layout algorithm */
        #flickrGrid {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
            position: relative;
        }

        .flickr-item {
            position: absolute;
            left: 0;
            top: 0;
            will-change: transform;
            overflow: hidden;
        }

        .flickr-item .image-wrapper {
            width: 100%;
            overflow: hidden;
        }

        .flickr-item img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        /* Caption styles - below image for most layouts */
        .caption {
            padding: 8px 12px;
            background: #222;
            color: #fff;
            font-size: 14px;
            line-height: 1.3;
            text-align: center;
        }

        /* Masonry items */
        .masonry-item {
            background: #222;
            overflow: hidden;
        }

        .masonry-item img {
            display: block;
        }

        /* Overflow/Fitscreen items */
        .overflowheight-item,
        .fitscreen-item {
            background: #222;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Gallery Layout Playground</h1>
    </div>

    <div class="controls">
        <div class="control-group">
            <span class="control-label">Images:</span>
            <button class="btn active" id="btnSamples" onclick="switchToSet('samples')">Samples (40)</button>
            <button class="btn" id="btnPics" onclick="switchToSet('pics')">Photos (68)</button>
        </div>
        <div class="divider"></div>
        <div class="control-group">
            <span class="control-label">Layout:</span>
            <button class="btn active" id="btnMasonry" onclick="switchLayout('masonry')">Masonry</button>
            <button class="btn" id="btnFlickrGrid" onclick="switchLayout('flickrgrid')">Flickr</button>
            <button class="btn" id="btnSquare" onclick="switchLayout('square')">Square</button>
            <button class="btn" id="btnFixed" onclick="switchLayout('fixed')">Fixed</button>
            <button class="btn" id="btnFitscreen" onclick="switchLayout('fitscreen')">Fit</button>
            <button class="btn" id="btnOverflowheight" onclick="switchLayout('overflowheight')">Overflow</button>
        </div>
    </div>

    <div class="stats" id="stats">40 samples</div>

    <div class="masonry-grid" id="masonryGrid">
        <div class="grid-sizer"></div>
    </div>

    <div id="squareGrid">
        <div class="square-grid"></div>
    </div>

    <div id="fixedGrid">
        <div class="fixed-grid"></div>
    </div>

    <div id="flickrGrid"></div>

    <div id="overflowheightGrid">
        <div class="overflowheight-grid"></div>
    </div>

    <div id="fitscreenGrid">
        <div class="fitscreen-grid"></div>
    </div>

    <script>
        // Static image list from pics/ folder
        const picsImages = [
            'pics/Img00001.jpg', 'pics/Img00002.jpg', 'pics/Img00003.jpg', 'pics/Img00004.jpg',
            'pics/Img00005.jpg', 'pics/Img00006.jpg', 'pics/Img00007.jpg', 'pics/Img00008.jpg',
            'pics/Img00009.jpg', 'pics/Img00010.jpg', 'pics/Img00011.jpg', 'pics/Img00012.jpg',
            'pics/Img00013.jpg', 'pics/Img00014.jpg', 'pics/Img00015.jpg', 'pics/Img00016.jpg',
            'pics/Img00017.jpg', 'pics/Img00018.jpg', 'pics/Img00019.jpg', 'pics/Img00020.jpg',
            'pics/Img00021.jpg', 'pics/Img00022.jpg', 'pics/Img00023.jpg', 'pics/Img00024.jpg',
            'pics/Img00025.jpg', 'pics/Img00026.jpg', 'pics/Img00027.jpg', 'pics/Img00028.jpg',
            'pics/Img00029.jpg', 'pics/Img00030.jpg', 'pics/Img00031.jpg', 'pics/Img00032.jpg',
            'pics/Img00033.jpg', 'pics/Img00034.jpg', 'pics/Img00035.jpg', 'pics/Img00036.jpg',
            'pics/Img00037.jpg', 'pics/Img00038.jpg', 'pics/Img00039.jpg', 'pics/Img00040.jpg',
            'pics/Img00041.jpg', 'pics/Img00042.jpg', 'pics/Img00043.jpg', 'pics/Img00044.jpg',
            'pics/Img00045.jpg', 'pics/Img00046.jpg', 'pics/Img00047.jpg', 'pics/Img00048.jpg',
            'pics/Img00049.jpg', 'pics/Img00050.jpg', 'pics/Img00051.jpg', 'pics/Img00052.jpg',
            'pics/Img00053.jpg', 'pics/Img00054.jpg', 'pics/Img00055.jpg', 'pics/Img00056.jpg',
            'pics/Img00057.jpg', 'pics/Img00058.jpg', 'pics/Img00059.jpg', 'pics/Img00060.jpg',
            'pics/Img00061.jpg', 'pics/Img00062.jpg', 'pics/Img00063.jpg', 'pics/Img00064.jpg',
            'pics/Img00065.jpg', 'pics/Img00066.jpg', 'pics/Img00067.jpg', 'pics/Img00068.jpg'
        ];

        // Sample images from samples/ folder - some with captions
        const samplesImages = [
            { src: 'samples/0001.jpg', caption: 'Morning light through the window' },
            'samples/0002.jpg',
            { src: 'samples/0003.jpg', caption: 'A quiet moment' },
            'samples/0004.jpg',
            'samples/0005.jpg',
            { src: 'samples/0006.jpg', caption: 'Reflections on water' },
            'samples/0007.jpg',
            'samples/0008.jpg',
            { src: 'samples/0009.jpg', caption: 'The old oak tree' },
            'samples/0010.jpg',
            'samples/0011.jpg',
            'samples/0012.jpg',
            { src: 'samples/0013.jpg', caption: 'Summer afternoon' },
            'samples/0014.jpg',
            'samples/0015.jpg',
            { src: 'samples/0016.jpg', caption: 'City lights at dusk' },
            'samples/0017.jpg',
            'samples/0018.jpg',
            'samples/0019.jpg',
            { src: 'samples/0020.jpg', caption: 'Patterns in nature' },
            'samples/0021.jpg',
            'samples/0022.jpg',
            'samples/0023.jpg',
            'samples/0024.jpg',
            { src: 'samples/0025.jpg', caption: 'First snow of winter' },
            'samples/0026.jpg',
            'samples/0027.jpg',
            'samples/0028.jpg',
            'samples/0029.jpg',
            { src: 'samples/0030.jpg', caption: 'Golden hour' },
            'samples/0031.jpg',
            'samples/0032.jpg',
            'samples/0033.jpg',
            'samples/0034.jpg',
            'samples/0035.jpg',
            { src: 'samples/0036.jpg', caption: 'Storm clouds gathering' },
            'samples/0037.jpg',
            'samples/0038.jpg',
            'samples/0039.jpg',
            { src: 'samples/0040.jpg', caption: 'End of the journey' }
        ];
        
        let currentSet = 'samples';
        let currentLayout = 'masonry';
        let currentImages = [...samplesImages];
        let msnry = null;
        
        // Cache for Flickr Grid - stores loaded image data to avoid reloading on resize
        let flickrGridCache = { images: null, loadedImages: null, elements: null };

        // ============================================================
        // Layout Registry - centralized layout configuration
        // ============================================================
        const layouts = {
            masonry: {
                gridId: 'masonryGrid',
                buttonId: 'btnMasonry',
                render: renderMasonryContent
            },
            square: {
                gridId: 'squareGrid',
                buttonId: 'btnSquare',
                render: renderSquareContent
            },
            fixed: {
                gridId: 'fixedGrid',
                buttonId: 'btnFixed',
                render: renderFixedContent
            },
            flickrgrid: {
                gridId: 'flickrGrid',
                buttonId: 'btnFlickrGrid',
                render: renderFlickrContent
            },
            overflowheight: {
                gridId: 'overflowheightGrid',
                buttonId: 'btnOverflowheight',
                render: renderOverflowheightContent
            },
            fitscreen: {
                gridId: 'fitscreenGrid',
                buttonId: 'btnFitscreen',
                render: renderFitscreenContent
            }
        };

        // ============================================================
        // Helper Functions
        // ============================================================
        
        // Helper: normalize item to { src, caption } format
        function normalizeItem(item) {
            if (typeof item === 'string') {
                return { src: item, caption: null };
            }
            return { src: item.src, caption: item.caption || null };
        }

        // Helper: create caption element if caption exists
        function createCaptionElement(caption) {
            if (!caption) return null;
            const captionEl = document.createElement('div');
            captionEl.className = 'caption';
            captionEl.textContent = caption;
            return captionEl;
        }

        // Helper: destroy masonry instance if it exists
        function teardownMasonry() {
            if (msnry) {
                msnry.destroy();
                msnry = null;
            }
        }

        // Helper: show only the specified grid, hide all others
        function showOnly(gridId) {
            Object.values(layouts).forEach(layout => {
                document.getElementById(layout.gridId).style.display = (layout.gridId === gridId) ? 'block' : 'none';
            });
        }

        // Helper: update button active states
        function updateButtonStates(activeLayout) {
            Object.entries(layouts).forEach(([name, config]) => {
                document.getElementById(config.buttonId).classList.toggle('active', name === activeLayout);
            });
        }

        // ============================================================
        // Layout Switching
        // ============================================================

        function switchToSet(setName) {
            if (setName === currentSet) return;
            
            currentSet = setName;
            
            // Update button states
            document.getElementById('btnPics').classList.toggle('active', setName === 'pics');
            document.getElementById('btnSamples').classList.toggle('active', setName === 'samples');
            
            // Switch image arrays
            if (setName === 'pics') {
                currentImages = [...picsImages];
                document.getElementById('stats').textContent = `${picsImages.length} photos`;
            } else {
                currentImages = [...samplesImages];
                document.getElementById('stats').textContent = `${samplesImages.length} samples`;
            }
            
            // Clear flickr cache when changing image set
            flickrGridCache = { images: null, loadedImages: null, elements: null };
            
            // Re-render with current layout
            renderCurrentLayout();
        }

        function switchLayout(layoutName) {
            if (layoutName === currentLayout) return;
            
            currentLayout = layoutName;
            updateButtonStates(layoutName);
            renderCurrentLayout();
        }

        function renderCurrentLayout() {
            const layout = layouts[currentLayout];
            if (layout) {
                // Teardown masonry before switching (unless we're switching TO masonry)
                if (currentLayout !== 'masonry') {
                    teardownMasonry();
                }
                showOnly(layout.gridId);
                layout.render(currentImages);
            }
        }

        // ============================================================
        // Masonry Layout
        // ============================================================

        function initMasonry() {
            const grid = document.getElementById('masonryGrid');
            
            // Destroy existing instance if it exists
            if (msnry) {
                msnry.destroy();
            }
            
            // Initialize Masonry
            msnry = new Masonry(grid, {
                itemSelector: '.masonry-item',
                columnWidth: '.grid-sizer',
                percentPosition: true,
                gutter: 15,
                originLeft: true,
                originTop: true,
                horizontalOrder: false
            });
            
            // Re-layout after all images load
            imagesLoaded(grid, function() {
                msnry.layout();
            });
        }

        function renderMasonryContent(images) {
            const grid = document.getElementById('masonryGrid');
            grid.innerHTML = '<div class="grid-sizer"></div>';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'masonry-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                itemEl.appendChild(img);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
            
            initMasonry();
        }

        // ============================================================
        // Square Grid Layout
        // ============================================================
        
        function renderSquareContent(images) {
            const grid = document.querySelector('#squareGrid .square-grid');
            grid.innerHTML = '';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'square-item';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                wrapper.appendChild(img);
                itemEl.appendChild(wrapper);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Fixed Grid Layout
        // ============================================================
        
        function renderFixedContent(images) {
            const grid = document.querySelector('#fixedGrid .fixed-grid');
            grid.innerHTML = '';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'fixed-item';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                wrapper.appendChild(img);
                itemEl.appendChild(wrapper);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Overflow Height Layout
        // ============================================================
        
        function renderOverflowheightContent(images) {
            const grid = document.querySelector('#overflowheightGrid .overflowheight-grid');
            grid.innerHTML = '';
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'overflowheight-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                itemEl.appendChild(img);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Fitscreen Layout
        // ============================================================

        function renderFitscreenContent(images) {
            const grid = document.querySelector('#fitscreenGrid .fitscreen-grid');
            grid.innerHTML = '';
            
            // Calculate available height for image
            // Viewport height - gap (between items) - caption height (padding + text)
            const gap = 15;
            const captionHeight = 36; // 8px padding top + 8px padding bottom + ~18px text (14px * 1.3)
            const viewportHeight = window.innerHeight;
            const imageMaxHeight = viewportHeight - gap - captionHeight;
            
            // Set CSS custom properties
            grid.style.setProperty('--fitscreen-gap', gap + 'px');
            grid.style.setProperty('--fitscreen-img-height', imageMaxHeight + 'px');
            
            images.forEach(item => {
                const { src, caption } = normalizeItem(item);
                const itemEl = document.createElement('div');
                itemEl.className = 'fitscreen-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = src.split('/').pop();
                
                itemEl.appendChild(img);
                
                const captionEl = createCaptionElement(caption);
                if (captionEl) itemEl.appendChild(captionEl);
                
                grid.appendChild(itemEl);
            });
        }

        // ============================================================
        // Flickr Grid Layout (justified-layout algorithm)
        // ============================================================

        function renderFlickrContent(images) {
            const container = document.getElementById('flickrGrid');
            
            // Wait for justified-layout module to load if not ready
            const doLayout = () => {
                // Check if we can use cached data
                const isSameImages = flickrGridCache.images === images && flickrGridCache.loadedImages;
                
                if (isSameImages) {
                    // Use cached data - just relayout
                    relayoutFlickrGrid();
                    return;
                }
                
                // Clear container for fresh render
                container.innerHTML = '';
                
                // Load all images to get their dimensions
                const imagePromises = images.map(item => {
                    const { src, caption } = normalizeItem(item);
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve({ src, caption, width: img.naturalWidth, height: img.naturalHeight });
                        img.onerror = () => resolve({ src, caption, width: 1, height: 1 }); // fallback
                        img.src = src;
                    });
                });
                
                Promise.all(imagePromises).then(loadedImages => {
                    // Cache the loaded image data
                    flickrGridCache.images = images;
                    flickrGridCache.loadedImages = loadedImages;
                    flickrGridCache.elements = [];
                    
                    // Get container width
                    const containerWidth = container.parentElement.clientWidth > 1400 ? 1400 : container.parentElement.clientWidth - 40;
                    
                    // Caption height constant (padding + line height + some buffer)
                    const CAPTION_HEIGHT = 35;
                    
                    // Prepare aspect ratios for justified-layout
                    const aspectRatios = loadedImages.map(img => img.width / img.height);
                    
                    // Run justified-layout algorithm
                    const geometry = window.justifiedLayout(aspectRatios, {
                        containerWidth: containerWidth,
                        targetRowHeight: 230,
                        boxSpacing: 15
                    });
                    
                    // Calculate total height accounting for captions
                    // We need to track row positions and add caption height where needed
                    let extraHeight = 0;
                    let currentRowTop = -1;
                    let rowHasCaption = false;
                    
                    // First pass: determine which rows have captions and calculate extra height
                    const rowCaptionOffsets = new Map(); // Maps row top position to extra offset
                    let cumulativeOffset = 0;
                    
                    geometry.boxes.forEach((box, index) => {
                        if (box.top !== currentRowTop) {
                            // New row - add offset from previous row's caption if any
                            if (rowHasCaption) {
                                cumulativeOffset += CAPTION_HEIGHT;
                            }
                            currentRowTop = box.top;
                            rowHasCaption = loadedImages[index].caption ? true : false;
                            rowCaptionOffsets.set(box.top, cumulativeOffset);
                        } else {
                            // Same row - check if this item has caption
                            if (loadedImages[index].caption) {
                                rowHasCaption = true;
                            }
                        }
                    });
                    // Add final row's caption height
                    if (rowHasCaption) {
                        cumulativeOffset += CAPTION_HEIGHT;
                    }
                    
                    // Set container height with caption offsets
                    container.style.height = (geometry.containerHeight + cumulativeOffset) + 'px';
                    
                    // Create positioned elements with adjusted positions
                    geometry.boxes.forEach((box, index) => {
                        const offset = rowCaptionOffsets.get(box.top) || 0;
                        const item = document.createElement('div');
                        item.className = 'flickr-item';
                        item.style.transform = `translate(${box.left}px, ${box.top + offset}px)`;
                        item.style.width = box.width + 'px';
                        
                        // Create image wrapper
                        const wrapper = document.createElement('div');
                        wrapper.className = 'image-wrapper';
                        wrapper.style.height = box.height + 'px';
                        
                        const img = document.createElement('img');
                        img.src = loadedImages[index].src;
                        img.alt = loadedImages[index].src.split('/').pop();
                        
                        wrapper.appendChild(img);
                        item.appendChild(wrapper);
                        
                        // Add caption if present
                        const captionEl = createCaptionElement(loadedImages[index].caption);
                        if (captionEl) item.appendChild(captionEl);
                        
                        container.appendChild(item);
                        
                        // Cache element reference for fast relayout
                        flickrGridCache.elements.push(item);
                    });
                });
            };
            
            if (window.justifiedLayout) {
                doLayout();
            } else {
                window.addEventListener('justifiedLayoutReady', doLayout, { once: true });
            }
        }
        
        // Fast relayout for Flickr Grid - reuses cached data and DOM elements
        function relayoutFlickrGrid() {
            if (!flickrGridCache.loadedImages || !flickrGridCache.elements) return;
            
            const container = document.getElementById('flickrGrid');
            const loadedImages = flickrGridCache.loadedImages;
            const elements = flickrGridCache.elements;
            
            // Get current container width
            const containerWidth = container.parentElement.clientWidth > 1400 ? 1400 : container.parentElement.clientWidth - 40;
            
            // Caption height constant
            const CAPTION_HEIGHT = 35;
            
            // Prepare aspect ratios
            const aspectRatios = loadedImages.map(img => img.width / img.height);
            
            // Recalculate layout
            const geometry = window.justifiedLayout(aspectRatios, {
                containerWidth: containerWidth,
                targetRowHeight: 230,
                boxSpacing: 15
            });
            
            // Calculate row caption offsets (same logic as initial render)
            let currentRowTop = -1;
            let rowHasCaption = false;
            const rowCaptionOffsets = new Map();
            let cumulativeOffset = 0;
            
            geometry.boxes.forEach((box, index) => {
                if (box.top !== currentRowTop) {
                    if (rowHasCaption) {
                        cumulativeOffset += CAPTION_HEIGHT;
                    }
                    currentRowTop = box.top;
                    rowHasCaption = loadedImages[index].caption ? true : false;
                    rowCaptionOffsets.set(box.top, cumulativeOffset);
                } else {
                    if (loadedImages[index].caption) {
                        rowHasCaption = true;
                    }
                }
            });
            if (rowHasCaption) {
                cumulativeOffset += CAPTION_HEIGHT;
            }
            
            // Update container height
            container.style.height = (geometry.containerHeight + cumulativeOffset) + 'px';
            
            // Update element positions and sizes (no DOM creation)
            geometry.boxes.forEach((box, index) => {
                const offset = rowCaptionOffsets.get(box.top) || 0;
                const item = elements[index];
                if (item) {
                    item.style.transform = `translate(${box.left}px, ${box.top + offset}px)`;
                    item.style.width = box.width + 'px';
                    // Update wrapper height
                    const wrapper = item.querySelector('.image-wrapper');
                    if (wrapper) {
                        wrapper.style.height = box.height + 'px';
                    }
                }
            });
        }

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            if (currentLayout === 'masonry' && msnry) {
                msnry.layout();
            } else if (currentLayout === 'flickrgrid') {
                // Debounce resize for flickr grid - use fast relayout
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => relayoutFlickrGrid(), 16); // ~60fps
            } else if (currentLayout === 'fitscreen') {
                // Recalculate fitscreen image height on resize
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const grid = document.querySelector('#fitscreenGrid .fitscreen-grid');
                    if (grid) {
                        const gap = 15;
                        const captionHeight = 36;
                        const imageMaxHeight = window.innerHeight - gap - captionHeight;
                        grid.style.setProperty('--fitscreen-img-height', imageMaxHeight + 'px');
                    }
                }, 16);
            }
        });

        // Load images on page load
        document.addEventListener('DOMContentLoaded', function() {
            renderCurrentLayout();
        });
    </script>
</body>
</html>
